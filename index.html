<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DFK Tournament Leaderboard</title>
  <style>
    :root{
      --bg:#09111f;
      --muted:#7f93b8;
      --text:#e9f0ff;
      --border:rgba(255,255,255,.10);
      --accent:#4ea1ff;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      --chipBg: rgba(255,255,255,.03);

      --toggleOff: rgba(255,255,255,.04);
      --toggleOn: rgba(255,255,255,.09);

      --tableGutter: 18px;

      --colHi: rgba(255,255,255,.03);
      --colHiHead: rgba(255,255,255,.035);

      --gold:#f5c451;

      /* unified dark modal palette */
      --overlayBg: rgba(0,0,0,.55);
      --modalBg: rgba(255,255,255,.04);
      --modalBd: rgba(255,255,255,.02);
      --modalBorder: rgba(255,255,255,.10);
      --modalHdr: rgba(255,255,255,.05);

      --tileShadow: 0 10px 26px rgba(0,0,0,.18);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(78,161,255,.18), transparent 55%),
        radial-gradient(900px 600px at 110% 0%, rgba(110,231,255,.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1240px;margin:0 auto;padding:10px}
    .headerInner, .mainNarrow{width:76%;margin:0 auto;}

    header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
    h1{margin:0}
    .siteTitle{font-size:clamp(18px,2.6vw,34px);letter-spacing:-.4px;font-weight:1000;line-height:1.05;white-space:nowrap;}
    .headerRight{display:flex;align-items:flex-start;justify-content:flex-end;min-width:160px}
    .playNowBtn{font-weight:900;letter-spacing:.6px;padding:10px 14px}
    .sub{color:var(--muted);font-size:12px;margin-top:2px;min-height:16px;}

    /* ‚úÖ TOP ROW: 4 items on one line */
    .topHeaderRow{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:10px;
      align-items:stretch;
      margin:10px 0 14px;
    }

    .miniTile,
    .topMiniBtn{
      height:50px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      box-shadow: var(--tileShadow);
      overflow:hidden;
      min-width:0;
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:6px 8px;
      text-align:center;
          text-decoration:none;
    }
    .miniTile.secondary{ background: rgba(255,255,255,.02); }

    .miniInner{
      width:100%;
      display:flex;
      align-items:baseline;
      justify-content:center;
      gap:6px;
      flex-wrap:wrap;
      min-width:0;
    }
    .miniInner .k{color:var(--muted);font-size:11px;white-space:nowrap}
    .miniInner .v{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900;
      white-space:nowrap;
      font-size:12px;
    }
    .miniInner .hint{color:var(--muted);font-size:11px;white-space:nowrap}

    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
      white-space:nowrap;
      text-align:center;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(78,161,255,.45);
      background: linear-gradient(135deg, rgba(78,161,255,.20), rgba(110,231,255,.10));
    }
    .btn.tiny{
      padding:5px 8px;border-radius:10px;font-size:11px;font-weight:900;line-height:1;
      background: rgba(255,255,255,.03);
    }
    .btn.active{
      background: var(--toggleOn);
      border-color: rgba(78,161,255,.35);
    }

    .topMiniBtn{
      font-weight:900;
      letter-spacing:.2px;
      padding:8px 10px;
      background: rgba(255,255,255,.04);
      color: #ffffff;
      cursor: pointer;
      user-select:none;
      transition:
        transform .08s ease,
        background .15s ease,
        border-color .15s ease,
        box-shadow .15s ease,
        filter .15s ease;
    }
    .topMiniBtn:hover{
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 12px 28px rgba(0,0,0,.28);
      filter: brightness(1.03);
    }
    .topMiniBtn:active{ transform: translateY(1px); }
    .topMiniBtn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(78,161,255,.18), 0 12px 28px rgba(0,0,0,.28);
      border-color: rgba(78,161,255,.35);
    }

    .philMini{
      border:1px solid rgba(78,161,255,.22);
      background:
        linear-gradient(135deg, rgba(78,161,255,.16), rgba(110,231,255,.08)),
        rgba(255,255,255,.02);
      color:#ffffff;
    }
    .philMini:hover{
      border-color: rgba(78,161,255,.38);
      background:
        linear-gradient(135deg, rgba(78,161,255,.22), rgba(110,231,255,.10)),
        rgba(255,255,255,.03);
    }

    @keyframes subtlePulse {
      0%   { background: rgba(255,255,255,.04); }
      4%   { background: rgba(255,255,255,.062); }
      8%   { background: rgba(255,255,255,.04); }
      100% { background: rgba(255,255,255,.04); }
    }
    .learnMini{
      font-size:13px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color:#ffffff;
      animation:none;
    }
    .learnMini.noPulse{ animation:none !important; }
    .learnMini:hover{
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.20);
    }

    input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      appearance:none;
      -webkit-appearance:none;
    }
    input:focus{
      background: rgba(0,0,0,.26);
      border-color: rgba(78,161,255,.45);
      box-shadow: 0 0 0 3px rgba(78,161,255,.12);
    }

    .topRow{
      display:grid;
      grid-template-columns: 0.85fr 1.075fr 1.075fr;
      gap:14px;
      align-items:stretch;
      margin-bottom:14px;
    }

    .tile{
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.02);
      border-radius: var(--radius);
      box-shadow: var(--tileShadow);
      height: var(--filtersH, auto);
      overflow:hidden;
      min-width:0;
    }
    .tile .hd{
      padding:12px 14px;
      border-bottom:1px dashed rgba(255,255,255,.16);
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:44px;
    }
    
    .hdCol{display:flex;flex-direction:column;gap:2px;min-width:0;}
.tile .hd .subhd{font-weight:800;color:rgba(233,240,255,.75);font-size:10px;white-space:nowrap;overflow:visible;text-overflow:clip;max-width:none;}
    .tile .bd{
      padding:14px;
      color: var(--muted);
      font-size:12px;
    }

    .filterGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

        .winsLabel{font-size:13px;font-weight:1000;color:rgba(233,240,255,.92);margin-top:2px;margin-bottom:-2px;}
/* Filters fit + tighter controls */
    #filtersCard .btn{ width:100%; }
    #filtersCard input{ min-width:0; }
    #filtersCard .dateBtn{
      min-width:0;
      overflow:hidden;
      padding:7px 8px;
      gap:6px;
      justify-content:space-between;
    }
    #filtersCard .dateBtn .lab{ font-size:9px; }
    #filtersCard .dateBtn .val{ font-size:11px; }
    .fullRow{grid-column: 1 / -1;}

    .dateBtn{
      width:100%;
      border:1px solid var(--border);
      background: var(--chipBg);
      color: var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      min-height:38px;
    }
    .dateBtn .lab{color:var(--muted); font-size:11px; white-space:nowrap}
    .dateBtn .val{font-weight:700; font-size:12px; white-space:nowrap}
    .dateBtn:hover{filter: brightness(1.05)}

    .dateHidden{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px}

    .toggleWrap{
      width:100%;
      display:flex;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
      height:38px;
    }
    .toggleBtn{
      flex:1 1 0;
      border:none;
      background: var(--toggleOff);
      color: var(--text);
      padding:0 10px;
      cursor:pointer;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition: background .15s ease, opacity .15s ease;
      min-width:0;
      white-space:nowrap;
    }
    .toggleBtn:hover{opacity:.95}
    .toggleBtn.active{ background: var(--toggleOn); }
    .toggleBtn + .toggleBtn{ border-left:1px solid var(--border); }

    .top3{display:flex;flex-direction:column;gap:10px;}
    .topItem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px;border:1px solid rgba(255,255,255,.10);
      border-radius:14px;background: rgba(255,255,255,.03);
    }
    .topLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .place{
      width:26px;height:26px;border-radius:9px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight:900;
      flex:0 0 auto;
      font-size:12px;
    }
    .topWallet{min-width:0;display:flex;flex-direction:column;gap:2px;}
    .topWallet a{
      min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      text-decoration:none;color: var(--accent);font-weight:900;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }
    .topWallet a:hover{text-decoration:underline;}
    .topMeta{font-size:11px;color: var(--muted);white-space:nowrap;}
    .topRight{text-align:right;white-space:nowrap;flex:0 0 auto;}
    .topReward{color:var(--gold);font-weight:1000;font-size:23px;line-height:1.05;}
    .topRewardLabel{color: var(--muted);font-size:11px;line-height:1.1;margin-top:2px;}
    .topEmpty{color: var(--muted);font-size:12px;padding:4px 2px;}

    /* Bigger Top 3 items: reduce side padding feel + slightly larger text */
    #lastWeekTile .top3, #lifetimeTile .top3{ margin:0 -10px; }
    #lastWeekTile .topItem, #lifetimeTile .topItem{
      padding:12px 14px;
      border-radius:16px;
    }
    #lastWeekTile .topWallet a, #lifetimeTile .topWallet a{ font-size:13px; }
    #lastWeekTile .topReward, #lifetimeTile .topReward{ font-size:20px; }

    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .lbCenter{flex:1; text-align:center; color:rgba(233,240,255,.85); font-weight:900; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .lbLeft{flex:0 0 auto;}
    .lbRight{flex:0 0 auto;}
    .tableWrap{
      max-height:560px;
      overflow:auto;
      padding-left: var(--tableGutter);
      padding-right: var(--tableGutter);
      scrollbar-gutter: stable;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:16px;
      line-height:1.25;
      table-layout: fixed;
    }
    thead th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.02);
      position:sticky; top:0;
      backdrop-filter: blur(8px);
      z-index:1;
      font-size:14px;
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      font-variant-numeric: tabular-nums;
    }
    tbody tr:hover{background: rgba(255,255,255,.03)}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .right{text-align:right}

    .rank{font-weight:700;width:70px}
    th.rank{width:70px}

    th.walletCol{width:44%;}
    th.col10{width:14%;}
    th.col20{width:14%;}
    th.colT {width:14%;}

    .link{color: var(--accent); text-decoration:none}
    .link:hover{text-decoration:underline}

    .walletCell{display:flex;align-items:center;gap:10px;min-width:0}
    .walletCell a{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .copyBtn{
      flex:0 0 auto;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius:10px;
      padding:6px 10px;
      cursor:pointer;
      font-size:12px;
      line-height:1;
      user-select:none;
      transition: background .15s ease, opacity .15s ease;
    }
    .copyBtn:hover{background: rgba(255,255,255,.06)}
    .copyBtn.copied{opacity:.95;border-color: rgba(78,161,255,.45)}

    .winsInline{
      display:inline-flex;
      align-items:baseline;
      justify-content:flex-end;
      gap:8px;
      white-space:nowrap;
      font-size:12px;
      font-weight:900;
      color: var(--text);
    }
    .winsInline .winsWord{
      font-size:12px;
      font-weight:900;
      color: var(--text);
    }
    .rewardBlock{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:center;
      gap:3px;
      line-height:1.05;
    }
    .rewardWins{
      font-size:12px;
      font-weight:900;
      color: var(--text);
      white-space:nowrap;
    }
    .rewardJewel{
      font-size:9px;
      font-weight:900;
      color: var(--gold);
      white-space:nowrap;
    }

    .clickWins{
      cursor:pointer;
      text-decoration:none;
    }
    .clickWins:hover{
      text-decoration: underline;
    }
    .clickWins:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(78,161,255,.14);
      border-radius: 10px;
    }

    .clickBreakdown{cursor:pointer;color:var(--accent);font-weight:900;}
    .clickBreakdown:hover{text-decoration:underline;}

    .colHi10 thead th.col10, .colHi10 tbody td.col10 { background: var(--colHi); }
    .colHi10 thead th.col10 { background: var(--colHiHead); }

    .colHi20 thead th.col20, .colHi20 tbody td.col20 { background: var(--colHi); }
    .colHi20 thead th.col20 { background: var(--colHiHead); }

    .colHiT  thead th.colT,  .colHiT  tbody td.colT  { background: var(--colHi); }
    .colHiT  thead th.colT  { background: var(--colHiHead); }

    .colHi10 thead th, .colHi20 thead th, .colHiT thead th { background: rgba(255,255,255,.02); }
    .colHi10 thead th.col10, .colHi20 thead th.col20, .colHiT thead th.colT { background: var(--colHiHead); }

    .modalBackdrop{
      position:fixed;inset:0;background: var(--overlayBg);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;
    }
    .modalBackdrop.show{display:flex;}
    .modal{
      width:min(780px, 100%);
      background: var(--modalBg);
      color: var(--text);
      border-radius:16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
      border:1px solid var(--modalBorder);
      backdrop-filter: blur(10px);
    }
    .modalHd{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--modalBorder);
      background: var(--modalHdr);
    }
    .modalTitle{font-weight:900}
    .modalBd{padding:14px;background: var(--modalBd)}

    /* Learn modal: center all copy */
    #learnBackdrop .modalBd, #learnBackdrop #learnText{ text-align:center; }
    #learnBackdrop #learnText ul{
      list-style-position: inside;
      padding-left:0;
      margin-left:0;
    }

    /* Leaderboard: hide scrollbars until interaction */
    .tableWrap{
      scrollbar-color: transparent transparent; /* Firefox */
    }
    .tableWrap:hover,
    .tableWrap:focus-within{
      scrollbar-color: rgba(255,255,255,.28) transparent;
    }
    .tableWrap::-webkit-scrollbar{ width:10px; height:10px; }
    .tableWrap::-webkit-scrollbar-track{ background: transparent; }
    .tableWrap::-webkit-scrollbar-thumb{
      background: transparent;
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    .tableWrap:hover::-webkit-scrollbar-thumb,
    .tableWrap:focus-within::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.28);
    }

    /* Back to top button (shown after scroll) */
    #backToTopBtn{ display:none; }
    #backToTopBtn.show{ display:inline-flex; }
    .modalNote{font-size:12px;color: var(--muted);margin:0 0 10px 0}
        .modalWarn{margin:0 0 10px;color:var(--warn);font-weight:900;}
    .tourneyLinks{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0 4px;}
    .tourneyLinks a{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);border-radius:12px;padding:8px 10px;text-decoration:none;font-weight:900;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .tourneyLinks a:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18);}
.modalBtns{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
    .modalBtn{
      border:1px solid var(--modalBorder);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:9px 10px;border-radius:12px;cursor:pointer;font-weight:800;
    }
    .modalBtn.primary{
      border-color: rgba(78,161,255,.35);
      background: linear-gradient(135deg, rgba(78,161,255,.16), rgba(110,231,255,.08));
    }
    .walletList{
      width:100%;min-height:240px;max-height:50vh;resize:vertical;
      padding:12px;border-radius:12px;border:1px solid var(--modalBorder);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;line-height:1.35;outline:none;
      background: rgba(0,0,0,.25);
      color: var(--text);
    }

    .top10List{display:flex;flex-direction:column;gap:10px;}
    .top10Item{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 10px;border:1px solid rgba(255,255,255,.10);
      border-radius:14px;background: rgba(255,255,255,.03);
    }
    .top10Left{display:flex;align-items:center;gap:10px;min-width:0;}
    .top10Place{
      width:28px;height:28px;border-radius:10px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight:900;font-size:12px;flex:0 0 auto;
    }
    .top10Wallet{min-width:0;display:flex;flex-direction:column;gap:2px;}
    .top10Wallet a{
      min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      text-decoration:none;color: var(--accent);font-weight:900;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }
    .top10Wallet a:hover{text-decoration:underline;}
    .top10Meta{font-size:11px;color: var(--muted);white-space:nowrap;}
    .top10Right{text-align:right;white-space:nowrap;flex:0 0 auto;}
    .top10Reward{font-weight:900;font-size:14px;color: var(--gold);}
    .top10RewardLabel{font-size:11px;color: var(--muted);margin-top:2px;}

    .pcOverlay{
      position:fixed;inset:0;background: var(--overlayBg);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:1200;
    }
    .pcOverlay.show{display:flex;}
    .pcBox{
      width: 640px;
      height: 390px;
      min-width: 320px;
      min-height: 220px;
      max-width: 92vw;
      max-height: 88vh;

      background: var(--modalBg);
      border:1px solid var(--modalBorder);
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;

      display:grid;
      grid-template-rows: auto 1fr;
      resize: both;
      backdrop-filter: blur(10px);
    }
    .pcHd{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px 8px;
      border-bottom:1px solid var(--modalBorder);
      background: var(--modalHdr);
    }
    .pcLeft{display:flex;gap:8px;align-items:center;min-width:0;}
    .pcPill{
      font-size:11px;padding:5px 9px;border-radius:999px;
      background: rgba(255,255,255,.08);color: var(--muted);
      white-space:nowrap;border:1px solid rgba(255,255,255,.10);
    }
    .pcTitle{
      font-size:12px;color: var(--text);opacity:.92;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      max-width: 42vw;font-weight:900;
    }
    .pcActions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .pcActions button{
      padding:6px 9px;font-size:11px;border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: #fff;
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
    }
    .pcActions button:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.18);
    }
    .pcActions button:active{transform: translateY(1px)}
    .pcActions button.close{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.18);
    }
    .pcActions button.close:hover{
      background: rgba(239,68,68,.26);
      border-color: rgba(239,68,68,.45);
    }
    .pcFrame{width:100%;height:100%;border:0;display:block;background:#000;}

    @media (max-width: 1200px){ .headerInner, .mainNarrow{width: 86%;} }
    @media (max-width: 1100px){ .headerInner, .mainNarrow{width: 92%;} }

    @media (max-width: 980px){
      .wrap{padding:14px}
      .headerInner, .mainNarrow{width:100%;}
      header{flex-direction:column;align-items:stretch;gap:12px}

      .topHeaderRow{
        grid-template-columns: 1fr 1fr;
        gap:10px;
      }

      .topRow{grid-template-columns: 1fr; display:flex; flex-direction:column;}
      #lastWeekTile{order:1;}
      #lifetimeTile{order:2;}
      #filtersCard{order:3;}
      .tile{height:auto;}
      table{ table-layout:auto; }
      th.walletCol{width:auto}
    }

    @media (max-width: 520px){
      :root{ --tableGutter: 12px; }
      .wrap{padding:12px}
      h1{font-size:17px}

      .topHeaderRow{grid-template-columns:1fr;gap:10px;}
      .miniTile,.topMiniBtn{height:54px;}

      table{font-size:15px}
      thead th{font-size:13px;padding:10px 10px}
      tbody td{padding:10px 10px}
      .rank{width:56px}
      .tableWrap{max-height:65vh}
      .filterGrid{gap:8px;}
      .dateBtn{min-height:38px;padding:8px 10px}

      .winsInline,.winsInline .winsWord,.rewardWins{font-size:12px;}
      .rewardJewel{font-size:9px;}

      .pcBox{width: 92vw; height: 54vh;}
    }
  </style>
</head>

<body>
<div class="wrap" id="app">
  <div class="headerInner">
    <header>
      <div>
        <h1 class="siteTitle">DFK Tournament Leaderboard</h1>
        <div class="sub" id="tagline">Your guide to weekly tournament rewards on Defi Kingdoms</div>
        <div class="sub" id="subline"></div>
        

        <div class="topHeaderRow">
          <a class="topMiniBtn" id="playNowBtn" href="https://game.defikingdoms.com/" target="_blank" rel="noopener noreferrer">
            PLAY DFK NOW
          </a>

          <button class="topMiniBtn learnMini" id="learnMoreBtn" type="button">LEARN MORE</button>

          <div class="miniTile">
            <div class="miniInner">
              <span class="v" id="utcNow">‚Äî</span>
            </div>
          </div>

          <div class="miniTile secondary">
            <div class="miniInner">
              <span class="k">Daily rollover in:</span>
              <span class="v" id="utcCountdown">‚Äî</span>
              
            </div>
          </div>

          <button class="topMiniBtn" id="philBtn" type="button">PHIL COLLINS</button>
        </div>
    </header>
  </div>

  <div class="mainNarrow">
    <div class="topRow">
      <section class="tile" id="filtersCard" aria-label="Filters">
        <div class="hd"><span>Filters</span><span class="subhd" id="filtersNote"></span></div>
        <div class="bd">
          <div class="filterGrid">
            <button class="dateBtn" id="fromBtn" type="button" title="Pick From date ">
              <span class="lab">From</span>
              <span class="val" id="fromLabel">‚Äî</span>
            </button>

            <button class="dateBtn" id="toBtn" type="button" title="Pick To date ">
              <span class="lab">To</span>
              <span class="val" id="toLabel">‚Äî</span>
            </button>

            <button class="btn" id="lastWeekBtn" type="button" aria-pressed="false">Last week</button>
            <button class="btn" id="thisWeekBtn" type="button" aria-pressed="true">This week</button>

            <div class="winsLabel fullRow"># Wins</div>

            <div class="toggleWrap fullRow" role="group" aria-label="Sort by tier">
              <button class="toggleBtn active" id="sort10Btn" type="button" aria-pressed="true">10s</button>
              <button class="toggleBtn" id="sort20Btn" type="button" aria-pressed="false">20s</button>
              <button class="toggleBtn" id="sortTotalBtn" type="button" aria-pressed="false">Total</button>
            </div>

            <div class="fullRow">
              <input id="search" placeholder="Search by wallet or name‚Ä¶" />
            </div>

            <div class="fullRow" id="updateLine" style="margin-top:8px;color:var(--muted);font-size:11px;font-weight:800;"></div>
          </div>

          <input class="dateHidden" id="fromDate" type="date" />
          <input class="dateHidden" id="toDate" type="date" />
        </div>
      </section>

      <aside class="tile" id="lastWeekTile" aria-label="Last week's top winners">
        <div class="hd">
          <span>Last week top 3</span>
          <span class="subhd" id="lastWeekRangeLabel">‚Äî</span>
        </div>
        <div class="bd">
          <div id="top3LastWeek" class="top3">
            <div class="topEmpty">Loading‚Ä¶</div>
          </div>
        </div>
      </aside>

      <aside class="tile" id="lifetimeTile" aria-label="Lifetime top winners">
        <div class="hd">
          <div style="display:flex;flex-direction:column;gap:2px;line-height:1.1;">
            <span>Lifetime top 3</span>
            <span style="font-size:10px;color:var(--muted);font-weight:800;">Tracking since Jan 16, 2026</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn tiny" id="showTop10Btn" type="button" title="Show top 10 lifetime earners">Show top 10</button>
          </div>
        </div>
        <div class="bd">
          <div id="top3Lifetime" class="top3">
            <div class="topEmpty">Loading‚Ä¶</div>
          </div>
        </div>
      </aside>
    </div>

    <section class="card">
      <div class="hd">
        <div class="lbLeft">
          <div style="font-size:12px;color:var(--muted)">Leaderboard</div>
          <div style="font-weight:700">Lvl 10 vs Lvl 20 wins</div>
        </div>

        <div class="lbCenter" id="rangeIndicator" aria-live="polite">
          <span id="rangeText">‚Äî</span>
          <button class="btn tiny" id="clearRangeBtn" type="button" style="margin-left:8px;display:none;">Clear</button>
        </div>

        <div class="lbRight" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn tiny" id="backToTopBtn" type="button" title="Back to top">Back to top</button>
          <button class="btn" id="walletsBtn" type="button" title="Show wallets">
            <span id="walletsBtnText">‚Äî wallets</span>
          </button>
          <button class="btn primary" id="csvBtn" type="button">
            <span>‚¨áÔ∏è</span> Export CSV
          </button>
        </div>
      </div>

      <div class="tableWrap" id="tableWrap">
        <table id="table">
          <thead>
            <tr>
              <th class="rank">Rank</th>
              <th class="walletCol">Wallet</th>
              <th class="right col10">Lvl 10</th>
              <th class="right col20">Lvl 20</th>
              <th class="right colT">Total</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" style="padding:14px;color:var(--muted)">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="walletModalTitle">
    <div class="modalHd">
      <div class="modalTitle" id="walletModalTitle">Wallets (copy-friendly)</div>
      <button class="modalBtn" id="modalCloseBtn" type="button">Close</button>
    </div>
    <div class="modalBd">
      <p class="modalNote">One wallet per line. Click inside, Ctrl+A, then copy. Or use the buttons below.</p>
      <textarea class="walletList" id="walletsText" readonly></textarea>
      <div class="modalBtns">
        <button class="modalBtn" id="modalCopyBtn" type="button">Copy all</button>
        <button class="modalBtn primary" id="modalCopySortedBtn" type="button">Copy sorted wallets</button>
      </div>
      <div class="modalNote" id="modalStatus" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<div class="modalBackdrop" id="top10Backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="top10Title">
    <div class="modalHd">
      <div class="modalTitle" id="top10Title">Top 10 lifetime JEWEL earners</div>
      <button class="modalBtn" id="top10CloseBtn" type="button">Close</button>
    </div>
    <div class="modalBd">
      <p class="modalNote">Ranked by lifetime Jewel reward. Shows total wins and the 10s/20s breakdown.</p>
      <div id="top10List" class="top10List"></div>
    </div>
  </div>
</div>

<div class="modalBackdrop" id="learnBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="learnTitle">
    <div class="modalHd">
      <div class="modalTitle" id="learnTitle">Learn more</div>
      <button class="modalBtn" id="learnCloseBtn" type="button">Close</button>
    </div>
    <div class="modalBd">
      <div id="learnText" style="font-size:14px; line-height:1.6; color:var(--text);">
        <p style="margin-top:0"><strong>Note:</strong> all times shown are in <strong>UTC</strong>.</p>

        <p>
          Every week, DFK players step into the arena and compete for tournament glory ‚Äî
          and the more <strong>1st place finishes</strong> you stack at
          <strong>Level 10</strong> and <strong>Level 20</strong>, the bigger your payout.
        </p>

        <p>
          Prizes are distributed weekly in <strong>JEWEL</strong> every
          <strong>Sunday/Monday</strong>, based on your total win count.
        </p>

        <h3 style="margin:14px 0 6px;">üèÜ Level 10 Rewards</h3>
        <ul style="margin:0 0 14px 20px;">
          <li><strong>3 wins</strong> = <strong>150 JEWEL</strong></li>
          <li><strong>5 wins</strong> = <strong>300 JEWEL</strong></li>
          <li><strong>10 wins</strong> = <strong>750 JEWEL</strong></li>
        </ul>

        <h3 style="margin:14px 0 6px;">‚öîÔ∏è Level 20 Rewards</h3>
        <ul style="margin:0 0 14px 20px;">
          <li><strong>Each win</strong> = <strong>60 JEWEL</strong></li>
        </ul>

        <p>
          Consistent winners get rewarded. The more first-place finishes you claim,
          the more JEWEL you take home.
        </p>

        <p style="margin-top:14px;">
          New to tournaments? Our community is active and genuinely helpful to newcomers.
          If you have questions about builds, strategy, or how payouts work,
          jump into our Discord and introduce yourself:
        </p>

        <p style="margin-top:6px;">
          üëâ <a href="https://discord.gg/M8pqR34W"
               target="_blank"
               rel="noopener noreferrer"
               style="color:var(--accent); font-weight:700;">
               https://discord.gg/M8pqR34W
             </a>
        </p>

        <div style="display:flex;justify-content:center;margin-top:12px;margin-bottom:6px;">
          <a href="https://game.defikingdoms.com/" target="_blank" rel="noopener noreferrer" class="dfk-button dfk-playNowBtn">
            PLAY DEFI KINGDOMS NOW
          </a>
        </div>

        <p style="margin-top:18px; margin-bottom:10px; font-weight:900; color:rgba(233,240,255,.92); text-align:center;">
          Check out these great DFK 3rd party tools from community developers
        </p>

        <!-- DFK Resource Buttons -->
        <style>
          .dfk-button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            margin-top: 18px;
            justify-content: center;
            width: 100%;
          }

          .dfk-button {
            background: #1e1e1e;
            color: #ffffff;
            border: 2px solid #c9a227;
            padding: 10px 18px;
            font-weight: 600;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            font-family: Arial, sans-serif;
          }

          .dfk-playNowBtn{padding:15px 26px;font-size:18px;font-weight:900;}

          .dfk-button:hover {
            background: #c9a227;
            color: #000000;
            box-shadow: 0 0 8px rgba(201, 162, 39, 0.6);
            transform: translateY(-2px);
          }
        </style>

        <div class="dfk-button-container" style="justify-content:center;">
          <a class="dfk-button" href="https://dfkplayertools.com/" target="_blank" rel="noopener noreferrer">
            dfkplayertools
          </a>

          <a class="dfk-button" href="https://dfkfoundry.com/" target="_blank" rel="noopener noreferrer">
            DFK Foundry
          </a>

          <a class="dfk-button" href="https://dfkhelper.com/" target="_blank" rel="noopener noreferrer">
            DFK Helper
          </a>

          <a class="dfk-button" href="https://www.adfk.app/" target="_blank" rel="noopener noreferrer">
            Adventures in DFK
          </a>

          <a class="dfk-button" href="https://defikingdoms.fandom.com/wiki/RenPen%27s_Quick_Start_Guide" target="_blank" rel="noopener noreferrer">
            Renpen&#39;s QuickStart Guide
          </a>

          <a class="dfk-button" href="https://mellowdfk.com/" target="_blank" rel="noopener noreferrer">
            Mellow&#39;s Tools
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
  </div>
</div>


<div class="modalBackdrop" id="tourneyBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="tourneyTitle">
    <div class="modalHd">
      <div class="modalTitle" id="tourneyTitle">Tournament IDs</div>
      <button class="modalBtn" id="tourneyCloseBtn" type="button">Close</button>
    </div>
    <div class="modalBd">
      <p class="modalNote" id="tourneyMeta">‚Äî</p>
      <p class="modalWarn">WARNING: Tournaments older than 7 days may have been cleared and will not open.</p>
      <div id="tourneyLinks" class="tourneyLinks"></div>
      <textarea class="walletList" id="tourneyText" readonly></textarea>
      <div class="modalBtns">
        <button class="modalBtn" id="tourneyCopyBtn" type="button">Copy IDs</button>
      </div>
      <div class="modalNote" id="tourneyStatus" style="margin-top:10px"></div>
    </div>
  </div>

<div class="modalBackdrop" id="tourneyLinksBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="tourneyLinksTitle">
    <div class="modalHd">
      <div class="modalTitle" id="tourneyLinksTitle">Tournament links</div>
      <button class="modalBtn" id="tourneyLinksCloseBtn" type="button">Close</button>
    </div>
    <div class="modalBd">
      <p class="modalNote" id="tourneyLinksMeta">‚Äî</p>
      <div id="tourneyLinksList" style="max-height:50vh;overflow:auto;padding:10px 12px;border-radius:12px;border:1px solid var(--modalBorder);background:rgba(0,0,0,.18);text-align:left;"></div>
      <div class="modalBtns">
        <button class="modalBtn" id="tourneyLinksCopyBtn" type="button">Copy links</button>
      </div>
      <div class="modalNote" id="tourneyLinksStatus" style="margin-top:10px"></div>
    </div>
  </div>
</div>

</div>

<div class="pcOverlay" id="pcOverlay" aria-hidden="true">
  <div class="pcBox" id="pcBox" role="dialog" aria-modal="true" aria-label="Phil Collins player">
    <div class="pcHd">
      <div class="pcLeft">
        <span class="pcPill">Resizable</span>
        <span class="pcTitle" id="pcTitle">‚Äî</span>
      </div>
      <div class="pcActions">
        <button type="button" id="pcTryAgain">Try again</button>
        <button type="button" data-pc-size="medium">Medium</button>
        <button type="button" data-pc-size="large">Large</button>
        <button type="button" class="close" id="pcClose">Close</button>
      </div>
    </div>

    <iframe
      id="pcFrame"
      class="pcFrame"
      title="YouTube video player"
      allow="autoplay; encrypted-media; picture-in-picture"
      allowfullscreen
      referrerpolicy="origin"
      src="about:blank">
    </iframe>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  const state = {
    wins: [],
    filtered: [],
    range: { fromMs: null, toMs: null },
    searchTimer: null,
    sortMode: "10s",
    lifetimeSorted: [],
    weekPreset: "this",
    namesByAddress: {},
    tournamentTierById: {},
    tournamentRangeById: {},
  };

  // Data availability start 
  const DATA_START_MS = Date.UTC(2026, 0, 16, 0,0,0,0);
  const DATA_START_ISO = "2026-01-16";

  function pad(n){ return String(n).padStart(2,"0"); }
  function pluralWins(n){ return n === 1 ? "win" : "wins"; }

  function toIsoDateUtc(ms){
    const d = new Date(ms);
    return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;
  }

  function fromIsoDateUtc(iso){
    if (!iso) return null;
    const [y,m,d] = iso.split("-").map(Number);
    if (![y,m,d].every(Number.isFinite)) return null;
    return Date.UTC(y, m-1, d, 0,0,0,0);
  }

  function formatPrettyUtc(ms){
    if (ms == null) return "‚Äî";
    const d = new Date(ms);
    const month = d.toLocaleString("en-US", { month: "short", timeZone: "UTC" });
    const day = d.getUTCDate();
    const year = d.getUTCFullYear();
    return `${month} ${day}, ${year}`;
  }

  function startOfUtcWeekMonday(ms){
    const d = new Date(ms);
    const day = d.getUTCDay();
    const diffToMonday = (day === 0 ? -6 : (1 - day));
    const base = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), 0,0,0,0));
    base.setUTCDate(base.getUTCDate() + diffToMonday);
    return base.getTime();
  }

  function updateDateLabels(){
    $("fromLabel").textContent = formatPrettyUtc(state.range.fromMs);
    $("toLabel").textContent = formatPrettyUtc(state.range.toMs);
  }

  function formatPrettyUtcInclusiveEnd(toMs){
    if (toMs == null) return "‚Äî";
    // show inclusive end date for ranges (toMs is exclusive midnight UTC)
    const end = toMs - 1;
    return formatPrettyUtc(end);
  }

  function updateRangeIndicator(){
    const el = $("rangeText");
    const clearBtn = $("clearRangeBtn");
    if (!el || !clearBtn) return;

    const preset = state.weekPreset;
    if (preset === "this"){
      el.textContent = "Showing this week";
      clearBtn.style.display = "none";
      return;
    }

    const f = formatPrettyUtc(state.range.fromMs);
    const t = formatPrettyUtcInclusiveEnd(state.range.toMs);
    el.textContent = `Showing ${f} to ${t}`;
    clearBtn.style.display = "inline-flex";
  }

  
  function clampRange(fromMs, toMs){
    let f = fromMs;
    let t = toMs;

    if (f != null && f < DATA_START_MS) f = DATA_START_MS;
    if (f == null) f = DATA_START_MS; // always keep range within available data
    if (t != null && t < DATA_START_MS) t = DATA_START_MS;

    if (t != null && f != null && t < f) t = f;

    return { fromMs: f, toMs: t };
  }

  function setRange(fromMs, toMs){
    const clamped = clampRange(fromMs, toMs);
    state.range.fromMs = clamped.fromMs;
    state.range.toMs = clamped.toMs;

    $("fromDate").min = DATA_START_ISO;
    $("toDate").min = DATA_START_ISO;

    $("fromDate").value = state.range.fromMs != null ? toIsoDateUtc(state.range.fromMs) : "";
    $("toDate").value = state.range.toMs != null ? toIsoDateUtc(state.range.toMs) : "";
    updateDateLabels();
    updateRangeIndicator();
  }

  function updateWeekPresetUI(){
    const isThis = state.weekPreset === "this";
    const isLast = state.weekPreset === "last";
    $("thisWeekBtn").classList.toggle("active", isThis);
    $("lastWeekBtn").classList.toggle("active", isLast);
    $("thisWeekBtn").setAttribute("aria-pressed", String(isThis));
    $("lastWeekBtn").setAttribute("aria-pressed", String(isLast));
  }

  function setThisWeek(){
    const now = Date.now();
    const mon = startOfUtcWeekMonday(now);
    const nextMon = mon + 7*86400000;
    setRange(mon, nextMon);
    state.weekPreset = "this";
    updateWeekPresetUI();
  }

  function setLastWeek(){
    const now = Date.now();
    const thisMon = startOfUtcWeekMonday(now);
    const lastMon = thisMon - 7*86400000;
    setRange(lastMon, thisMon);
    state.weekPreset = "last";
    updateWeekPresetUI();
  }

  function setCustomRange(){
    state.weekPreset = "custom";
    updateWeekPresetUI();
  }

  function shortWallet(addr){
    if (!addr || addr.length < 12) return addr || "";
    return addr.slice(0, 6) + "‚Ä¶" + addr.slice(-4);
  }

  function displayName(wallet){
    const w = (wallet || "").toLowerCase();
    const n = state.namesByAddress[w];
    if (n && typeof n === "string" && n.trim()) return n.trim();
    return shortWallet(w);
  }

  function normalizeTournamentId(v){
    if (v == null) return "";
    if (typeof v === "number") return String(v);
    if (typeof v === "string") return v.trim();
    try { return String(v); } catch { return ""; }
  }

  function tierOverrideForTournamentId(tournamentId){
    const id = normalizeTournamentId(tournamentId);
    if (!id) return null;
    const t = state.tournamentTierById[id];
    return (t === 10 || t === 20) ? t : null;
  }

  function jewel10(w10){
    if (w10 >= 10) return 750;
    if (w10 >= 5) return 300;
    if (w10 >= 3) return 150;
    return 0;
  }
  function jewel20(w20){
    if (w20 < 1) return 0;
    return 60 * w20;
  }
  function formatJewel(n){ return `${n.toLocaleString()} JEWEL`; }

  function aggregateWins(wins, fromMs, toMs){
    const by = new Map();
    for (const w of wins){
      const tMs = w.timestamp * 1000;
      if (fromMs != null && tMs < fromMs) continue;
      if (toMs != null && tMs >= toMs) continue;

      const cur = by.get(w.wallet) || {
        wallet: w.wallet,
        lvl10Wins: 0,
        lvl20Wins: 0,
        total: 0,
        ids10: new Set(),
        ids20: new Set(),
        idsAll: new Set(),
      };

      const tid = w.tournamentId ? String(w.tournamentId) : "";
      if (tid) cur.idsAll.add(tid);

      if (w.tier === 10){
        cur.lvl10Wins++;
        if (tid) cur.ids10.add(tid);
      } else if (w.tier === 20){
        cur.lvl20Wins++;
        if (tid) cur.ids20.add(tid);
      }

      cur.total++;
      by.set(w.wallet, cur);
    }

    const rows = [...by.values()].map(r => ({
      ...r,
      ids10: [...r.ids10].sort((a,b)=>Number(a)-Number(b)),
      ids20: [...r.ids20].sort((a,b)=>Number(a)-Number(b)),
      idsAll: [...r.idsAll].sort((a,b)=>Number(a)-Number(b)),
    }));

    return { rows };
  }

  function enrichWithJewel(rows){
    return rows.map(r => {
      const j10 = jewel10(r.lvl10Wins);
      const j20 = jewel20(r.lvl20Wins);
      const jT = j10 + j20;
      return { ...r, j10, j20, jT };
    });
  }

  function sortRows(rows){
    const mode = state.sortMode;
    const cmp =
      mode === "20s"
        ? (a,b)=> (b.lvl20Wins - a.lvl20Wins) || (b.total - a.total) || a.wallet.localeCompare(b.wallet)
        : mode === "total"
          ? (a,b)=> (b.total - a.total) || (b.lvl10Wins - a.lvl10Wins) || (b.lvl20Wins - a.lvl20Wins) || a.wallet.localeCompare(b.wallet)
          : (a,b)=> (b.lvl10Wins - a.lvl10Wins) || (b.total - a.total) || a.wallet.localeCompare(b.wallet);
    return rows.sort(cmp);
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch{
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return ok;
      }catch{
        return false;
      }
    }
  }

  function setColumnHighlight(){
    const tbl = $("table");
    if (!tbl) return;
    tbl.classList.remove("colHi10","colHi20","colHiT");
    if (state.sortMode === "10s") tbl.classList.add("colHi10");
    else if (state.sortMode === "20s") tbl.classList.add("colHi20");
    else tbl.classList.add("colHiT");
  }

  function setToggleUI(){
    const is10 = state.sortMode === "10s";
    const is20 = state.sortMode === "20s";
    const isT  = state.sortMode === "total";
    $("sort10Btn").classList.toggle("active", is10);
    $("sort20Btn").classList.toggle("active", is20);
    $("sortTotalBtn").classList.toggle("active", isT);
    $("sort10Btn").setAttribute("aria-pressed", String(is10));
    $("sort20Btn").setAttribute("aria-pressed", String(is20));
    $("sortTotalBtn").setAttribute("aria-pressed", String(isT));
  }

  function updateWalletsButton(count){
    $("walletsBtnText").textContent = `${count.toLocaleString()} wallets`;
  }

  function renderCell(winsCount, jewelAmount, ids, wallet, col){
    const idsStr = (ids && ids.length) ? ids.join("\n") : "";
    const encoded = encodeURIComponent(idsStr);

    if (!jewelAmount){
      return `
        <span class="winsInline clickWins"
              role="button"
              tabindex="0"
              data-ids="${encoded}"
              data-wallet="${wallet}"
              data-col="${col}"
              title="Click to view tournament IDs">
          <span>${winsCount.toLocaleString()}</span>
          <span class="winsWord">${pluralWins(winsCount)}</span>
        </span>
      `;
    }

    return `
      <div class="rewardBlock">
        <div class="rewardWins clickWins"
             role="button"
             tabindex="0"
             data-ids="${encoded}"
             data-wallet="${wallet}"
             data-col="${col}"
             title="Click to view tournament IDs">
          ${winsCount.toLocaleString()} ${pluralWins(winsCount)}
        </div>
        <div class="rewardJewel">${formatJewel(jewelAmount)}</div>
      </div>
    `;
  }

  function renderTable(rows){
    const tb = $("tbody");
    if (!rows.length){
      tb.innerHTML = `<tr><td colspan="5" style="padding:14px;color:var(--muted)">No results for this range.</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map(r => {
      const j10 = jewel10(r.lvl10Wins);
      const j20 = jewel20(r.lvl20Wins);
      const jT  = j10 + j20;

      const name = displayName(r.wallet);
      const wShort = shortWallet(r.wallet);

      return `
        <tr>
          <td class="rank">${r.rank}</td>
          <td class="mono">
            <div class="walletCell">
              <a class="link"
                 href="https://andromeda-explorer.metis.io/address/${r.wallet}"
                 target="_blank"
                 rel="noreferrer"
                 title="${wShort}">
                 ${name}
              </a>
              <button class="copyBtn" type="button" data-copy="${r.wallet}" title="Copy wallet">Copy</button>
            </div>
          </td>

          <td class="right col10">${renderCell(r.lvl10Wins, j10, r.ids10, r.wallet, "10")}</td>
          <td class="right col20">${renderCell(r.lvl20Wins, j20, r.ids20, r.wallet, "20")}</td>
          <td class="right colT">${renderCell(r.total, jT, r.idsAll, r.wallet, "T")}</td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll(".copyBtn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const wallet = btn.getAttribute("data-copy");
        const ok = await copyToClipboard(wallet);
        if (!ok) return;
        btn.classList.add("copied");
        const prev = btn.textContent;
        btn.textContent = "Copied!";
        setTimeout(() => {
          btn.textContent = prev;
          btn.classList.remove("copied");
        }, 1200);
      });
    });

    tb.querySelectorAll(".clickWins").forEach(el => {
      const open = () => {
        const wallet = el.getAttribute("data-wallet") || "";
        const col = el.getAttribute("data-col") || "T";
        const idsText = decodeURIComponent(el.getAttribute("data-ids") || "");
        // Always open (if IDs are missing, the modal will explain)
        openTourneyLinksModal(wallet, col, idsText);
      };
      el.addEventListener("click", open);
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); open(); }
      });
    });
  }

  function apply(){
    const search = ($("search").value || "").trim().toLowerCase();
    const fromMs = state.range.fromMs;
    const toMs = state.range.toMs;

    const agg = aggregateWins(state.wins, fromMs, toMs);
    let rows = agg.rows;

    if (search){
      rows = rows.filter(r => {
        const w = r.wallet.toLowerCase();
        const n = (state.namesByAddress[w] || "").toLowerCase();
        return w.includes(search) || n.includes(search);
      });
    }

    sortRows(rows);

    const ranked = rows.map((r, i)=> ({ rank: i+1, ...r }));
    state.filtered = ranked;

    updateWalletsButton(ranked.length);
    setToggleUI();
    setColumnHighlight();
    renderTable(ranked);
  }

  function exportCsv(){
    const rows = state.filtered;
    if (!rows.length) return;

    const header = ["rank","wallet","name","lvl10Wins","lvl20Wins","totalWins","lvl10Jewel","lvl20Jewel","totalJewel"];
    const lines = [header.join(",")];
    for (const r of rows){
      const j10 = jewel10(r.lvl10Wins);
      const j20 = jewel20(r.lvl20Wins);
      const jT = j10 + j20;
      const name = (state.namesByAddress[r.wallet] || "").replaceAll('"','""');
      lines.push([r.rank, r.wallet, `"${name}"`, r.lvl10Wins, r.lvl20Wins, r.total, j10, j20, jT].join(","));
    }
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "dfk-leaderboard.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function fmtCountdown(ms){
    const total = Math.max(0, Math.floor(ms / 1000));
    const hh = String(Math.floor(total / 3600)).padStart(2,"0");
    const mm = String(Math.floor((total % 3600) / 60)).padStart(2,"0");
    const ss = String(total % 60).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }

  
  function nextUpdateUtcMs(nowMs){
    const d = new Date(nowMs);
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const day = d.getUTCDate();
    const h = d.getUTCHours();
    const nextH = (Math.floor(h / 3) * 3) + 3; // next 3-hour boundary
    if (nextH >= 24){
      return Date.UTC(y, m, day + 1, 0, 0, 0, 0);
    }
    return Date.UTC(y, m, day, nextH, 0, 0, 0);
  }

  function setUtcWidgets(){
    const now = new Date();
    const nowMs = now.getTime();
    const clock = now.toISOString().replace("T"," ").slice(0,19) + "Z";
    $("utcNow").textContent = clock;

    const nextMidnightUtcMs = Date.UTC(
      now.getUTCFullYear(),
      now.getUTCMonth(),
      now.getUTCDate() + 1,
      0,0,0,0
    );
    $("utcCountdown").textContent = fmtCountdown(nextMidnightUtcMs - nowMs);

    const nextUpMs = nextUpdateUtcMs(nowMs);
    const nextUpIso = new Date(nextUpMs).toISOString().replace("T"," ").slice(0,19) + "Z";
    $("updateLine").textContent = `Next leaderboard update: ${nextUpIso} (in ${fmtCountdown(nextUpMs - nowMs)})`;
  }

  function openModal(backdropId){
    const b = $(backdropId);
    b.classList.add("show");
    b.setAttribute("aria-hidden","false");
  }
  function closeModal(backdropId){
    const b = $(backdropId);
    b.classList.remove("show");
    b.setAttribute("aria-hidden","true");
  }

  function openWalletsModal(){
    const wallets = state.filtered.map(r => r.wallet);
    $("walletsText").value = wallets.join("\n");
    $("modalStatus").textContent = "";
    openModal("modalBackdrop");
    setTimeout(() => $("walletsText").focus(), 0);
  }
  async function modalCopyAll(){
    const text = $("walletsText").value || "";
    const ok = await navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
    $("modalStatus").textContent = ok ? "Copied all wallets to clipboard." : "Copy failed (browser blocked clipboard).";
  }
  async function modalCopySortedOnly(){
    const text = state.filtered.map(r => r.wallet).join("\n");
    const ok = await navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
    $("modalStatus").textContent = ok ? "Copied sorted wallets to clipboard." : "Copy failed (browser blocked clipboard).";
  }

  function colLabel(col){
    if (col === "10") return "Lvl 10";
    if (col === "20") return "Lvl 20";
    return "Total";
  }
  function openTourneyModal(wallet, col, idsText){
    $("tourneyTitle").textContent = `${colLabel(col)} tournament IDs`;
    $("tourneyMeta").textContent = `${displayName(wallet)} ‚Ä¢ Range: ${formatPrettyUtc(state.range.fromMs)} ‚Üí ${formatPrettyUtc(state.range.toMs)}`;
    $("tourneyText").value = idsText || "";
    $("tourneyStatus").textContent = "";
    openModal("tourneyBackdrop");
    setTimeout(() => $("tourneyText").focus(), 0);
  }

  function tourneyUrl(id){
    const tid = normalizeTournamentId(id);
    if (!tid) return "";
    return `https://game.defikingdoms.com/registry/tournaments/${tid}`;
  }

  function openTourneyLinksModal(wallet, tier, idsText){
    const ids = (idsText || "").split(/\s+/).map(s=>s.trim()).filter(Boolean);
    const label = tier === 20 ? "Lvl 20" : "Lvl 10";
    $("tourneyLinksTitle").textContent = `${label} tournament links`;
    $("tourneyLinksMeta").textContent = `${displayName(wallet)} ‚Ä¢ Last week ‚Ä¢ ${ids.length.toLocaleString()} ${ids.length === 1 ? "tournament" : "tournaments"}`;
    $("tourneyLinksStatus").textContent = "";

    if (!ids.length){
      $("tourneyLinksList").innerHTML = `<div style="color:var(--muted);font-size:12px;">No tournaments found.</div>`;
    } else {
      $("tourneyLinksList").innerHTML = `<ul style="margin:0;padding-left:18px;line-height:1.6;">${
        ids.map(tid => {
          const url = tourneyUrl(tid);
          return `<li><a href="${url}" target="_blank" rel="noopener noreferrer" style="color:var(--accent);font-weight:800;text-decoration:none;">${url}</a></li>`;
        }).join("")
      }</ul>`;
    }

    // store for copy
    $("tourneyLinksList").setAttribute("data-copy", ids.map(tid => tourneyUrl(tid)).join("\n"));

    openModal("tourneyLinksBackdrop");
    setTimeout(() => $("tourneyLinksCloseBtn").focus(), 0);
  }

  function sizeTilesToFilters(){
    const filters = $("filtersCard");
    const last = $("lastWeekTile");
    const life = $("lifetimeTile");
    if (!filters || !last || !life) return;

    const isStacked = window.matchMedia("(max-width: 980px)").matches;
    if (isStacked){
      last.style.height = "auto";
      life.style.height = "auto";
      return;
    }

    const rect = filters.getBoundingClientRect();
    const h = Math.round(rect.height) + "px";
    last.style.setProperty("--filtersH", h);
    life.style.setProperty("--filtersH", h);
  }

  function lastWeekRangeMs(){
    const now = Date.now();
    const thisMon = startOfUtcWeekMonday(now);
    const lastMon = thisMon - 7*86400000;
    return { fromMs: lastMon, toMs: thisMon };
  }

  function computeLastWeekTop(){
    const { fromMs, toMs } = lastWeekRangeMs();
    $("lastWeekRangeLabel").textContent = `${formatPrettyUtc(fromMs)} ‚Üí ${formatPrettyUtc(toMs)}`;

    const rows = aggregateWins(state.wins, fromMs, toMs).rows;
    const enriched = enrichWithJewel(rows);

    enriched.sort((a,b)=>
      (b.jT - a.jT) ||
      (b.total - a.total) ||
      (b.lvl10Wins - a.lvl10Wins) ||
      (b.lvl20Wins - a.lvl20Wins) ||
      a.wallet.localeCompare(b.wallet)
    );
    return enriched;
  }

  function renderTopList(containerId, rows, takeN){
    const host = $(containerId);
    const isLastWeek = containerId === "top3LastWeek";
    const top = rows.filter(x => x.jT > 0).slice(0, takeN);

    if (!top.length){
      host.innerHTML = `<div class="topEmpty">No JEWEL rewards earned.</div>`;
      return;
    }

    host.innerHTML = top.map((r, idx) => {
      const place = idx + 1;
      const name = displayName(r.wallet);

      const ids10 = (r.ids10 || []).join("\n");
      const ids20 = (r.ids20 || []).join("\n");
      const enc10 = encodeURIComponent(ids10);
      const enc20 = encodeURIComponent(ids20);

      const winsLine = isLastWeek
        ? `${r.total.toLocaleString()} ${pluralWins(r.total)} ‚Ä¢ <span class="clickBreakdown" role="button" tabindex="0" data-wallet="${r.wallet}" data-tier="10" data-ids="${enc10}" title="Click to view Level 10 tournaments">10s: ${r.lvl10Wins}</span> ‚Ä¢ <span class="clickBreakdown" role="button" tabindex="0" data-wallet="${r.wallet}" data-tier="20" data-ids="${enc20}" title="Click to view Level 20 tournaments">20s: ${r.lvl20Wins}</span>`
        : `${r.total.toLocaleString()} ${pluralWins(r.total)} ‚Ä¢ 10s: ${r.lvl10Wins} ‚Ä¢ 20s: ${r.lvl20Wins}`;

      return `
        <div class="topItem">
          <div class="topLeft">
            <span class="place">${place}</span>
            <div class="topWallet">
              <a href="https://andromeda-explorer.metis.io/address/${r.wallet}" target="_blank" rel="noreferrer" title="${shortWallet(r.wallet)}">${name}</a>
              <div class="topMeta">${winsLine}</div>
            </div>
          </div>
          <div class="topRight">
            <div class="topReward">${r.jT.toLocaleString()} JEWEL</div>
          </div>
        </div>
      `;
    }).join("");

    if (isLastWeek){
      host.querySelectorAll(".clickBreakdown").forEach(el => {
        const open = () => {
          const wallet = el.getAttribute("data-wallet") || "";
          const tier = el.getAttribute("data-tier") === "20" ? 20 : 10;
          const idsText = decodeURIComponent(el.getAttribute("data-ids") || "");
          openTourneyLinksModal(wallet, tier, idsText);
        };
        el.addEventListener("click", open);
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); open(); }
        });
      });
    }
  }

  function computeLifetimeTop(){
    const rows = aggregateWins(state.wins, DATA_START_MS, null).rows;
    const enriched = enrichWithJewel(rows);

    enriched.sort((a,b)=>
      (b.jT - a.jT) ||
      (b.total - a.total) ||
      (b.lvl10Wins - a.lvl10Wins) ||
      (b.lvl20Wins - a.lvl20Wins) ||
      a.wallet.localeCompare(b.wallet)
    );

    state.lifetimeSorted = enriched;
    return enriched;
  }

  function openTop10Modal(){
    const list = state.lifetimeSorted.filter(x => x.jT > 0).slice(0, 10);
    const host = $("top10List");

    if (!list.length){
      host.innerHTML = `<div style="color:var(--muted);font-size:12px;">No JEWEL rewards earned yet.</div>`;
    } else {
      host.innerHTML = list.map((r, idx) => {
        const place = idx + 1;
        const name = displayName(r.wallet);
        const winsLine = `${r.total.toLocaleString()} ${pluralWins(r.total)} ‚Ä¢ 10s: ${r.lvl10Wins} ‚Ä¢ 20s: ${r.lvl20Wins}`;
        return `
          <div class="top10Item">
            <div class="top10Left">
              <span class="top10Place">${place}</span>
              <div class="top10Wallet">
                <a href="https://andromeda-explorer.metis.io/address/${r.wallet}" target="_blank" rel="noreferrer" title="${shortWallet(r.wallet)}">${name}</a>
                <div class="top10Meta">${winsLine}</div>
              </div>
            </div>
            <div class="top10Right">
              <div class="top10Reward">${r.jT.toLocaleString()} JEWEL</div>
              
            </div>
          </div>
        `;
      }).join("");
    }

    openModal("top10Backdrop");
  }

  const philCollinsSongs = [
    { title: "In the Air Tonight", id: "YkADj0TPrJA" },
    { title: "Against All Odds (Take a Look at Me Now)", id: "CkBfT7ZQy9Q" },
    { title: "Another Day in Paradise", id: "Qt2mbGP6vFI" },
    { title: "One More Night", id: "zKVq-P3z5Vg" },
    { title: "Sussudio", id: "r0qBaBb1Y-U" },
    { title: "Easy Lover (with Philip Bailey)", id: "JkRKT6T0QLg" },
    { title: "Two Hearts", id: "SidxJz94Svs" },
    { title: "I Don't Care Anymore", id: "C6PNc9KN50M" },
    { title: "You Can't Hurry Love", id: "C9IWXj4R6Y8" },
    { title: "A Groovy Kind of Love", id: "HsC_SARyPzk" },
    { title: "Take Me Home", id: "sRY1NG1P_kw" },
    { title: "I Wish It Would Rain Down", id: "YcY3FH208l8" },
    { title: "Separate Lives", id: "k9olaIio3l8" },
    { title: "Both Sides of the Story", id: "8uDgWv7z2xU" },
    { title: "Dance Into the Light", id: "xODK_OxzR8I" },
    { title: "Something Happened on the Way to Heaven", id: "qW7tR2eE9G8" },
    { title: "Do You Remember?", id: "uWb6X0qVZ2A" }
  ];

  let lastPhil = null;

  function pickRandom(arr){
    return arr[Math.floor(Math.random() * arr.length)];
  }
  function pickRandomNotSame(arr, prev){
    if (!prev || arr.length < 2) return pickRandom(arr);
    let pick = prev;
    for (let i=0; i<10 && pick === prev; i++){
      pick = pickRandom(arr);
    }
    return pick;
  }

  function setPhilSize(size){
    const box = $("pcBox");
    const sizes = {
      medium: { w: 640, h: 390 },
      large:  { w: 900, h: 520 }
    };
    const s = sizes[size] || sizes.medium;

    const maxW = Math.floor(window.innerWidth * 0.92);
    const maxH = Math.floor(window.innerHeight * 0.88);

    box.style.width = Math.min(s.w, maxW) + "px";
    box.style.height = Math.min(s.h, maxH) + "px";
  }

  function openPhil(video){
    lastPhil = video;
    $("pcTitle").textContent = video.title;
    $("pcOverlay").classList.add("show");
    $("pcOverlay").setAttribute("aria-hidden","false");
    $("pcFrame").src = `https://www.youtube.com/embed/${video.id}?autoplay=1&rel=0`;
  }

  function closePhil(){
    $("pcOverlay").classList.remove("show");
    $("pcOverlay").setAttribute("aria-hidden","true");
    $("pcFrame").src = "about:blank";
  }

  function playPhil(){
    const pick = pickRandomNotSame(philCollinsSongs, lastPhil);
    setPhilSize("medium");
    openPhil(pick);
  }

  function tryAgainPhil(){
    if (!$("pcOverlay").classList.contains("show")) return playPhil();
    const pick = pickRandomNotSame(philCollinsSongs, lastPhil);
    openPhil(pick);
  }

  function initLearnPulse(){
    const btn = $("learnMoreBtn");
    const stopped = localStorage.getItem("learn_pulse_stopped") === "1";
    if (stopped) btn.classList.add("noPulse");

    btn.addEventListener("click", () => {
      openModal("learnBackdrop");
      btn.classList.add("noPulse");
      localStorage.setItem("learn_pulse_stopped", "1");
    });
  }

  async function fetchJsonMaybe(url){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) return null;
      return await res.json();
    }catch{
      return null;
    }
  }

  function buildTierOverridesFromRangesJson(rangesJson){
    const map = {};
    if (!rangesJson) return map;

    const obj = rangesJson.rangesByTournamentId || rangesJson.tournamentRangesById || null;
    if (obj && typeof obj === "object"){
      for (const [k,v] of Object.entries(obj)){
        const tier = Number(v?.tier);
        if (tier === 10 || tier === 20) map[String(k)] = tier;
      }
      return map;
    }

    if (Array.isArray(rangesJson)){
      for (const row of rangesJson){
        const id = normalizeTournamentId(row?.tournamentId ?? row?.id);
        if (!id) continue;
        const maxL = Number(row?.maxLevel);
        const minL = Number(row?.minLevel);
        const tier = Number(row?.tier) || ((Number.isFinite(maxL) && maxL >= 16) || (Number.isFinite(minL) && minL >= 11) ? 20 : 10);
        if (tier === 10 || tier === 20) map[id] = tier;
      }
      return map;
    }

    if (typeof rangesJson === "object"){
      for (const [k,v] of Object.entries(rangesJson)){
        if (k === "updatedAtUtc" || k === "source" || k === "meta") continue;
        const tier = Number(v?.tier);
        if (tier === 10 || tier === 20) map[String(k)] = tier;
      }
    }
    return map;
  }

  async function load(){
    try{
      const json = await fetchJsonMaybe("./leaderboard.json");
      if (!json) throw new Error("Failed to load leaderboard.json");

      const profilesJson = await fetchJsonMaybe("./profiles.json");
      if (profilesJson && profilesJson.namesByAddress && typeof profilesJson.namesByAddress === "object"){
        state.namesByAddress = {};
        for (const [addr, name] of Object.entries(profilesJson.namesByAddress)){
          const a = (addr || "").toLowerCase();
          if (!a) continue;
          if (typeof name === "string" && name.trim()) state.namesByAddress[a] = name.trim();
        }
      } else {
        state.namesByAddress = {};
      }

      const rangesJson = await fetchJsonMaybe("./tournamentRanges.json");
      state.tournamentTierById = buildTierOverridesFromRangesJson(rangesJson);

      const wins = Array.isArray(json.wins) ? json.wins : [];
      state.wins = wins
        .map(w => {
          const wallet = (w.wallet || "").toLowerCase();
          const timestamp = Number(w.timestamp);
          const tournamentId = normalizeTournamentId(
            w.tournamentId ?? w.tournamentID ?? w.tournament_id ?? w.tournament ?? w.tid ?? w.tourneyId ?? w.id ?? ""
          );
          const overrideTier = tierOverrideForTournamentId(tournamentId);
          const baseTier = (w.tier === 10 ? 10 : (w.tier === 20 ? 20 : null));
          const tier = overrideTier ?? baseTier;
          return { wallet, timestamp, tier, tournamentId };
        })
        .filter(w => w.wallet && Number.isFinite(w.timestamp) && (w.timestamp * 1000) >= DATA_START_MS);

      if (!Object.keys(state.tournamentTierById || {}).length){
        $("subline").textContent = "Note: tournamentRanges.json not found (tier overrides not applied yet). Run the tier builder script.";
      } else {
        $("subline").textContent = "";
      }

      setThisWeek();
      setToggleUI();
      setColumnHighlight();
      apply();

      const lastWeekSorted = computeLastWeekTop();
      renderTopList("top3LastWeek", lastWeekSorted, 3);

      const lifetimeSorted = computeLifetimeTop();
      renderTopList("top3Lifetime", lifetimeSorted, 3);

      requestAnimationFrame(() => sizeTilesToFilters());
    } catch (e){
      $("tbody").innerHTML =
        `<tr><td colspan="5" style="padding:14px;color:var(--bad)">Error loading data: ${String(e.message || e)}</td></tr>`;
      $("subline").textContent = "";
      $("top3LastWeek").innerHTML = `<div class="topEmpty" style="color:var(--bad)">Error loading data.</div>`;
      $("top3Lifetime").innerHTML = `<div class="topEmpty" style="color:var(--bad)">Error loading data.</div>`;
      requestAnimationFrame(() => sizeTilesToFilters());
    }
  }

  $("csvBtn").addEventListener("click", exportCsv);
  $("walletsBtn").addEventListener("click", openWalletsModal);

  $("modalCloseBtn").addEventListener("click", () => closeModal("modalBackdrop"));
  $("modalBackdrop").addEventListener("click", (e) => { if (e.target === $("modalBackdrop")) closeModal("modalBackdrop"); });
  $("modalCopyBtn").addEventListener("click", modalCopyAll);
  $("modalCopySortedBtn").addEventListener("click", modalCopySortedOnly);

  $("showTop10Btn").addEventListener("click", openTop10Modal);
  $("top10CloseBtn").addEventListener("click", () => closeModal("top10Backdrop"));
  $("top10Backdrop").addEventListener("click", (e) => { if (e.target === $("top10Backdrop")) closeModal("top10Backdrop"); });

  $("learnCloseBtn").addEventListener("click", () => closeModal("learnBackdrop"));
  $("learnBackdrop").addEventListener("click", (e) => { if (e.target === $("learnBackdrop")) closeModal("learnBackdrop"); });

  $("tourneyCloseBtn").addEventListener("click", () => closeModal("tourneyBackdrop"));
  $("tourneyBackdrop").addEventListener("click", (e) => { if (e.target === $("tourneyBackdrop")) closeModal("tourneyBackdrop"); });
  $("tourneyCopyBtn").addEventListener("click", async () => {
    const text = $("tourneyText").value || "";
    const ok = await navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
    $("tourneyStatus").textContent = ok ? "Copied tournament IDs to clipboard." : "Copy failed (browser blocked clipboard).";
  });


  $("tourneyLinksCloseBtn").addEventListener("click", () => closeModal("tourneyLinksBackdrop"));
  $("tourneyLinksBackdrop").addEventListener("click", (e) => { if (e.target === $("tourneyLinksBackdrop")) closeModal("tourneyLinksBackdrop"); });
  $("tourneyLinksCopyBtn").addEventListener("click", async () => {
    const text = $("tourneyLinksList").getAttribute("data-copy") || "";
    const ok = await navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
    $("tourneyLinksStatus").textContent = ok ? "Copied tournament links to clipboard." : "Copy failed (browser blocked clipboard).";
  });

  $("thisWeekBtn").addEventListener("click", () => {
    setThisWeek(); apply();
    const lastWeekSorted = computeLastWeekTop(); renderTopList("top3LastWeek", lastWeekSorted, 3);
    requestAnimationFrame(() => sizeTilesToFilters());
  });
  $("lastWeekBtn").addEventListener("click", () => {
    setLastWeek(); apply();
    const lastWeekSorted = computeLastWeekTop(); renderTopList("top3LastWeek", lastWeekSorted, 3);
    requestAnimationFrame(() => sizeTilesToFilters());
  });

  $("clearRangeBtn").addEventListener("click", () => {
    setThisWeek(); apply();
    const lastWeekSorted = computeLastWeekTop(); renderTopList("top3LastWeek", lastWeekSorted, 3);
    requestAnimationFrame(() => sizeTilesToFilters());
  });

  $("fromBtn").addEventListener("click", () => {
    const el = $("fromDate");
    try{ el.showPicker ? el.showPicker() : (el.focus(), el.click()); }catch{ el.focus(); el.click(); }
  });
  $("toBtn").addEventListener("click", () => {
    const el = $("toDate");
    try{ el.showPicker ? el.showPicker() : (el.focus(), el.click()); }catch{ el.focus(); el.click(); }
  });

  $("fromDate").addEventListener("change", () => {
    const fMs = fromIsoDateUtc($("fromDate").value);
    setRange(fMs, state.range.toMs);
    setCustomRange();
    apply();
    requestAnimationFrame(() => sizeTilesToFilters());
  });

  $("toDate").addEventListener("change", () => {
    const tMs = fromIsoDateUtc($("toDate").value);
    setRange(state.range.fromMs, tMs);
    setCustomRange();
    apply();
    requestAnimationFrame(() => sizeTilesToFilters());
  });

  $("search").addEventListener("input", () => {
    if (state.searchTimer) clearTimeout(state.searchTimer);
    state.searchTimer = setTimeout(() => { apply(); }, 120);
  });
  $("search").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (state.searchTimer) clearTimeout(state.searchTimer);
      apply();
    }
  });

  $("sort10Btn").addEventListener("click", () => { state.sortMode = "10s"; apply(); });
  $("sort20Btn").addEventListener("click", () => { state.sortMode = "20s"; apply(); });
  $("sortTotalBtn").addEventListener("click", () => { state.sortMode = "total"; apply(); });

  window.addEventListener("resize", () => sizeTilesToFilters());

  $("philBtn").addEventListener("click", playPhil);
  $("pcTryAgain").addEventListener("click", tryAgainPhil);
  $("pcClose").addEventListener("click", closePhil);
  $("pcOverlay").addEventListener("click", (e)=>{ if (e.target === $("pcOverlay")) closePhil(); });
  document.querySelectorAll("[data-pc-size]").forEach(btn => {
    btn.addEventListener("click", () => setPhilSize(btn.dataset.pcSize));
  });


  // Ensure Last-week Top 3 breakdown links always work (10s/20s)
  document.addEventListener("click", (e) => {
    const el = (e.target && e.target.closest) ? e.target.closest(".clickBreakdown") : null;
    if (!el) return;
    const wallet = el.getAttribute("data-wallet") || "";
    const tier = el.getAttribute("data-tier") === "20" ? 20 : 10;
    const idsText = decodeURIComponent(el.getAttribute("data-ids") || "");
    if (!idsText.trim()) return;
    openTourneyLinksModal(wallet, tier, idsText);
  });

  document.addEventListener("keydown", (e) => {
    const t = e.target;
    if (!t || !t.classList || !t.classList.contains("clickBreakdown")) return;
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      const wallet = t.getAttribute("data-wallet") || "";
      const tier = t.getAttribute("data-tier") === "20" ? 20 : 10;
      const idsText = decodeURIComponent(t.getAttribute("data-ids") || "");
      if (!idsText.trim()) return;
      openTourneyLinksModal(wallet, tier, idsText);
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if ($("pcOverlay").classList.contains("show")) closePhil();
    if ($("learnBackdrop").classList.contains("show")) closeModal("learnBackdrop");
    if ($("top10Backdrop").classList.contains("show")) closeModal("top10Backdrop");
    if ($("modalBackdrop").classList.contains("show")) closeModal("modalBackdrop");
    if ($("tourneyBackdrop").classList.contains("show")) closeModal("tourneyBackdrop");
    if ($("tourneyLinksBackdrop").classList.contains("show")) closeModal("tourneyLinksBackdrop");
  });

  window.addEventListener("resize", () => {
    if (!$("pcOverlay").classList.contains("show")) return;
    const box = $("pcBox");
    const curW = parseInt(getComputedStyle(box).width, 10);
    const curH = parseInt(getComputedStyle(box).height, 10);
    const maxW = Math.floor(window.innerWidth * 0.92);
    const maxH = Math.floor(window.innerHeight * 0.88);
    box.style.width = Math.min(curW, maxW) + "px";
    box.style.height = Math.min(curH, maxH) + "px";
  });

  // Back to top (appears in the Leaderboard header after you scroll down)
  (function initBackToTop(){
    const btn = $("backToTopBtn");
    if (!btn) return;

    const refresh = () => {
      const show = window.scrollY > 300;
      btn.classList.toggle("show", show);
      btn.setAttribute("aria-hidden", String(!show));
    };

    btn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    window.addEventListener("scroll", refresh, { passive: true });
    refresh();
  })();


  initLearnPulse();
  setToggleUI();
  updateWeekPresetUI();
  setUtcWidgets();
  setInterval(setUtcWidgets, 1000);
  load();
</script>
</body>
</html>
