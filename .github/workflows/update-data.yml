name: Update leaderboard data (hourly)

on:
  workflow_dispatch:
  schedule:
    # Every hour (UTC). GitHub schedules are best-effort.
    - cron: "0 * * * *"

permissions:
  contents: write

concurrency:
  group: update-leaderboard-data
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      # Required
      RPC_URL: ${{ secrets.RPC_URL }}
      SUBGRAPH_ENDPOINT: ${{ secrets.SUBGRAPH_ENDPOINT }}
      TOURNAMENT_DIAMOND: ${{ secrets.TOURNAMENT_DIAMOND }}
      # Optional / used by your tier builder if present
      SEED_TX_L10: ${{ secrets.SEED_TX_L10 }}
      SEED_TX_L20: ${{ secrets.SEED_TX_L20 }}
      # If your scripts expect these names instead, add them too
      rpc_url: ${{ secrets.RPC_URL }}
      subgraph_endpoint: ${{ secrets.SUBGRAPH_ENDPOINT }}
      tournament_diamond: ${{ secrets.TOURNAMENT_DIAMOND }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Sanity check required secrets
        run: |
          set -e
          if [ -z "${RPC_URL}" ]; then echo "Missing RPC_URL (set repo secret RPC_URL)"; exit 1; fi
          if [ -z "${SUBGRAPH_ENDPOINT}" ]; then echo "Missing SUBGRAPH_ENDPOINT (set repo secret SUBGRAPH_ENDPOINT)"; exit 1; fi
          if [ -z "${TOURNAMENT_DIAMOND}" ]; then echo "Missing TOURNAMENT_DIAMOND (set repo secret TOURNAMENT_DIAMOND)"; exit 1; fi

      # --- Run your data builder(s) ---
      # Adjust these commands to match your repo scripts.
      - name: Build leaderboard + profiles
        run: |
          set -e
          npm run build:data

      - name: Build tournamentRanges (tier overrides)
        run: |
          set -e
          # If your repo uses a different script name, change it here.
          npm run build:tiers

      # --- Commit generated artifacts ---
      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Stage generated files
        id: stage
        run: |
          set -e
          # Stage both root + public versions (some repos keep one, some both)
          git add public/leaderboard.json public/profiles.json public/tournamentRanges.json 2>/dev/null || true
          git add leaderboard.json profiles.json tournamentRanges.json 2>/dev/null || true
          git add scripts/.cache/tournament-tier-cache.json scripts/.cache/profiles-name-cache.json 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "committed=false" >> $GITHUB_OUTPUT
            echo "No changes to commit."
          else
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit
        if: steps.stage.outputs.committed == 'true'
        run: |
          set -e
          git commit -m "chore: update leaderboard data"

      - name: Push (no rebase; avoid conflicts on generated files)
        if: steps.stage.outputs.committed == 'true'
        run: |
          set -e
          git fetch origin main
          git checkout main
          git reset --hard origin/main

          # Re-apply the staged/generated changes on top of latest main
          git add public/leaderboard.json public/profiles.json public/tournamentRanges.json 2>/dev/null || true
          git add leaderboard.json profiles.json tournamentRanges.json 2>/dev/null || true
          git add scripts/.cache/tournament-tier-cache.json scripts/.cache/profiles-name-cache.json 2>/dev/null || true

          git commit -m "chore: update leaderboard data" || echo "No changes"
          git push origin main
